---
  - name: Wait for SSH to come up
    wait_for: port=22 timeout=320 state=started

  - name: Add the Service Fabric APT Repo
    apt_repository: repo='deb [arch=amd64] http://apt-mo.trafficmanager.net/repos/servicefabric/ trusty main' state=present

  - name: Add the Service Fabric APT Key
    apt_key: keyserver=apt-mo.trafficmanager.net id=417A0893

  - name: Add Ubuntu Keyserver
    apt_key: keyserver=keyserver.ubuntu.com id=68576280

  - name: Add the Nodejs APT Repo
    apt_repository: repo='deb https://deb.nodesource.com/node_4.x trusty main' state=present

  - name: Add the Nodejs APT Src Repo
    apt_repository: repo='deb-src https://deb.nodesource.com/node_4.x trusty main' state=present

  - name: Update APT Cache
    apt: update_cache=yes

  - name: Set up authorized_keys for the ubuntu user
    authorized_key: user=ubuntu key="{{ item }}"
    with_file:
      - "{{ role_path }}/files/mr.pub"
      - "{{ role_path }}/files/rajeet.pub"


  - name: Install Nodejs, OpenSSH Server and Client, Docker
    apt: name={{item}}
    with_items:
       - nodejs
       - openssh-server
       - openssh-client
       - docker.io

  - name: Open firewall for cluster communication
    ufw: state=enabled policy=allow

  - name: Install Service Fabric SDK
    raw: yes y | sudo apt-get install servicefabricsdk -y

  - name: Generate and Copy Cluster Manifest
    template: src="{{ role_path }}/templates/manifest.xml" dest=/opt/microsoft/sdk/servicefabric/clustersetup/nonsecure/servicefabric-scalemin.xml mode=0775

  - name: Run SDK Setup
    raw: sudo /opt/microsoft/sdk/servicefabric/sdksetup.sh

  - name: Run Cluster Setup
    raw: cd /opt/microsoft/sdk/servicefabric/clustersetup && sudo ./devclustercleanup.sh && sudo ./devclustersetup.sh
